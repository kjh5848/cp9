좋아, 1장부터 바로 달릴게. “공통 규칙 레이어”는 이후 전 단계의 안정성을 좌우하니까, **응답 헬퍼 + 타입 + CORS + 헬로 API**만 먼저 최소로 깔아두자. (Supabase Edge Functions / Deno 기준)

---

# 1장 실전: 공통 규칙 레이어 (응답 규격, 타입, CORS)

## 디렉토리 구조 (제안)

```
supabase/
└─ functions/
   ├─ _shared/
   │  ├─ cors.ts
   │  ├─ response.ts
   │  └─ types.ts
   └─ hello/
      └─ index.ts

```

---

## _shared/cors.ts

```tsx
// _shared/cors.ts
export const corsHeaders: HeadersInit = {
  "Access-Control-Allow-Origin": "*", // 운영 시 도메인 화이트리스트 권장
  "Access-Control-Allow-Headers": "authorization, x-client-version, content-type",
  "Access-Control-Allow-Methods": "GET,POST,OPTIONS",
  "Access-Control-Max-Age": "86400",
};

```

> 운영 전환 시 * 대신 https://moritail.com 등 화이트리스트로 바꾸는 걸 권장.
> 

---

## _shared/types.ts

```tsx
// _shared/types.ts

export type ApiSuccess<T> = {
  success: true;
  data: T;
};

export type ApiError = {
  success: false;
  error: string;
  code?: string; // "ENUM" 형태의 에러 코드
  // 필요 시 디버그용 부가정보 추가 가능(ex. requestId)
};

export type ApiResponse<T> = ApiSuccess<T> | ApiError;

/** 파이프라인 전역 기본 타입들 (점진 확장) */
export type CandidateItem = {
  id: string;                 // item_hash 등
  url: string;
  title: string;
  priceKRW?: number | null;
  isRocket?: boolean | null;
  image?: string | null;
  categoryPath?: string[];
};

export type ResearchPack = {
  itemId: string;
  title?: string;
  priceKRW?: number | null;
  isRocket?: boolean | null;
  features?: string[];
  pros?: string[];
  cons?: string[];
  keywords?: string[];
  metaTitle?: string;
  metaDescription?: string;
  slug?: string;
};

export type SeoDraft = {
  itemId: string;
  meta: {
    title: string;
    description: string;
    slug: string;
    tags?: string[];
  };
  markdown: string; // 본문
};

```

---

## _shared/response.ts

```tsx
// _shared/response.ts
import { corsHeaders } from "./cors.ts";

const baseHeaders: HeadersInit = {
  ...corsHeaders,
  "content-type": "application/json; charset=utf-8", // 한글 깨짐 방지
};

export function ok<T>(data: T, init?: ResponseInit): Response {
  return new Response(
    JSON.stringify({ success: true, data }),
    { status: init?.status ?? 200, headers: { ...baseHeaders, ...(init?.headers || {}) } }
  );
}

export function fail(message: string, code?: string, status = 400, extra?: Record<string, unknown>): Response {
  const body: Record<string, unknown> = { success: false, error: message };
  if (code) body.code = code;
  if (extra) Object.assign(body, extra);

  return new Response(
    JSON.stringify(body),
    { status, headers: baseHeaders }
  );
}

```

---

## hello/index.ts (헬로 API)

```tsx
// functions/hello/index.ts
// Deno 표준 서버
import { serve } from "https://deno.land/std@0.224.0/http/server.ts";
import { corsHeaders } from "../_shared/cors.ts";
import { ok, fail } from "../_shared/response.ts";

serve(async (req) => {
  // 프리플라이트
  if (req.method === "OPTIONS") {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    // 간단한 핑/상태 확인 용도
    return ok({ message: "hello, pipeline v1" });
  } catch (err) {
    // 예외 안전망
    console.error(err);
    return fail("UNEXPECTED_ERROR", "UNEXPECTED_ERROR", 500);
  }
});

```

---

## 로컬 실행 & 테스트

1. 로컬 실행

```bash
supabase functions serve --env-file .env.local

```

1. cURL 테스트

```bash
curl -i "http://localhost:54321/functions/v1/hello"
# 기대 응답: { "success": true, "data": { "message": "hello, pipeline v1" } }

```

1. 프론트에서 호출 (예: Next.js)

```tsx
const res = await fetch(`${process.env.NEXT_PUBLIC_SUPABASE_URL}/functions/v1/hello`, {
  method: "GET",
  headers: { "Content-Type": "application/json" },
});
const json = await res.json(); // { success: true, data: { message: "hello, pipeline v1" } }
console.log(json);

```

---

## 흔한 함정 체크리스트

- **OPTIONS 미처리** → CORS 에러 (반드시 위처럼 조기 리턴)
- `content-type`에 `charset=utf-8` 누락 → **한글 깨짐**
- 엔드포인트마다 응답 모양 다름 → **ok/fail 강제 사용**으로 통일
- 프론트에서 `res.ok`만 보지 말고 **`success` 필드를 기준**으로 분기

---

## 미니 과제 (1장)

- 지금 만든 `hello`를 호출해 **브라우저 콘솔에** 정확히 아래 형태가 찍히는지 확인
    
    ```json
    { "success": true, "data": { "message": "hello, pipeline v1" } }
    
    ```
    
- 이후 실제 기능 함수에도 **반드시 `ok`/`fail`만** 사용하도록 린트 규칙/코드 리뷰 체크포인트로 묶기.

---

다음 장(2장 검색 레이어)로 넘어갈 준비 끝!

원하면 바로 **쿠팡 파트너스 검색 API 래퍼**를 같은 규약으로 붙여줄게.